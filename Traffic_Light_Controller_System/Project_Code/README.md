# Traffic Light Fuzzy Logic Controller

This repository contains the main code for the **Traffic Light Fuzzy Logic Controller** project. This project demonstrates the implementation of fuzzy logic in VHDL, applied to a functional traffic light system. The system uses real-time data to adaptively control green light durations across various lanes, showcasing the potential of fuzzy logic in practical applications.

### Note
The **UART Modules** and **Fuzzy Input Modules** used in this project are explained in detail within their own sections and repositories:
- [UART Modules](https://github.com/Traffic-Light-Senior-Design/Fuzzy-Logic-Traffic-Light-Controller-Using-FPGA/tree/Michael/Crosswalk_Timers/Kria_Kr260_Code)
- [Fuzzy Input Modules](https://github.com/Traffic-Light-Senior-Design/Fuzzy-Logic-Traffic-Light-Controller-Using-FPGA/tree/Michael/VHDL_Fuzzy_Logic_System)

### Overview
This README provides a detailed look at:
- A general overview of how each traffic light sequence operates.
- The state machine that connects and coordinates these sequences.
- The input scalar module, debounce filter, and top module integration.

### Table of Contents
| Section                                      | Description                                                 |
|----------------------------------------------|-------------------------------------------------------------|
| [Sequence Controllers Overview](#traffic-light-sequence-controller-general-documentation) | General explanation of how each traffic light sequence operates. |
| [State Machine](#state-machine)              | Overview of the state machine connecting the sequences.      |
| [Input Scalar Module](#input-scalar-module)  | Manages real-time traffic input data and scales it accordingly. |
| [Debounce Filter Module](#debounce-filter-module) | Stabilizes input signals to avoid erroneous transitions.      |
| [Top Module](#top-module)                    | Integrates all components, forming the complete system.     |
| [Constraints](#additional-files)             | The Constraints file used for the kria kr260		     |

## Traffic Light Sequence Controller - General Documentation

The **Traffic Light Sequence Controllers** are central modules responsible for managing the green light durations across various lanes within a traffic light system. Each controller dynamically adjusts its assigned green light timing based on the traffic density in real-time, leveraging a cohesive integration of fuzzy logic components to optimize traffic flow. Through the combined use of the input, rule base, and output modules, each sequence controller translates traffic data into adaptive green light durations, ensuring a smooth and responsive system.

### Purpose and Role in Traffic System
The main objective of each **Traffic Light Sequence Controller** is to regulate the green light timing for a specific lane or set of lanes by adapting to the detected traffic density. Rather than using fixed timing intervals, these controllers adjust the green light duration according to the real-time traffic conditions, reducing idle wait times, alleviating congestion, and promoting a more fluid traffic experience.

### Connecting and Coordinating Fuzzy Logic Components
Each sequence controller orchestrates the fuzzy logic modules to process input data and generate a suitable output, ensuring all components work together seamlessly:
1. **Traffic Data Input**: Each controller receives an 8-bit vector representing traffic density. This data is routed to the **input module**, which uses fuzzy logic to transform the raw traffic data into fuzzy membership degrees (e.g., low, medium, high) that represent how much the current density aligns with these levels.
   
2. **Rule Base Application**: The fuzzy membership degrees generated by the input module are passed to the **rule base module** through direct port mapping. In the rule base, these degrees are evaluated against predefined rules that determine the appropriate green light duration. Each rule base is tailored to fit the specific needs of its assigned lane, with rule types and conditions configured to match common traffic scenarios. These rules dictate the output membership degrees, which indicate the desired green light duration level for the current traffic state.

3. **Output Calculation and Final Signal**: Once the rule base has evaluated the membership degrees, the **output module** takes the combined results and performs defuzzification, converting the fuzzy output into a precise green light duration (a crisp value). This crisp value is then assigned to the `green_light_output` signal, providing a calculated green light timing tailored to the current traffic density for the controller’s designated lane.

### Strengths and Benefits
Through this integration of fuzzy logic modules, each **Traffic Light Sequence Controller** provides the following advantages:
- **Adaptive Timing**: The controllers adjust the green light duration based on real-time traffic density rather than using fixed timings, ensuring a responsive and efficient traffic flow.
- **Real-Time Responsiveness**: Since each controller processes live data from its lane, it can adapt to fluctuations in traffic, adjusting green light durations instantly to meet changing demands.
- **Modularity and Scalability**: Each sequence controller is modular and can be replicated or adjusted for multiple lanes, making it straightforward to scale or customize the system to fit any intersection configuration.

### Overall System Flow
In summary, each **Traffic Light Sequence Controller** serves as a bridge between traffic density data and the optimized timing decisions needed for effective traffic management. By coordinating input fuzzification, rule evaluation, and output defuzzification, each controller provides consistent, adaptive timing that meets the specific demands of its lane, resulting in a flexible, scalable traffic light system capable of handling diverse traffic conditions efficiently.

### Sequence Controller Differences

Below are the specific differences among the various traffic light sequence controllers, focusing on each controller's unique configurations and settings.

---

### L1 Sequence Controller
- **Single Lane Input**: This controller handles only the `L1` input, represented by an 8-bit vector, making it a straightforward configuration.
- **Membership Function Points and Slopes**: `L1` has **3 membership functions** (low, medium, high) with points `(0, 10, 45)` and `(0, 45, 100)`, and slopes `(0, 728, 728)` and `(566, 728, 0)`.
- **Rule Configuration**:
  - This controller has **3 rules**, one for each level of `L1` traffic (low, medium, high).
  - **Output Notation**: Maps the low, medium, and high membership functions to specific green light durations.
- **Output Singleton Values**: Uses singleton values of `15`, `22`, and `30`, providing green light durations optimized for single-lane traffic flow.

### L2L3_L7L8 Sequence Controller
- **Multiple Lane Inputs**: This controller handles two separate inputs, `L2L3` and `L7L8`, each represented by a distinct 8-bit vector, meaning it manages traffic data from two lanes simultaneously.
- **Membership Function Points and Slopes**: Both `L2L3` and `L7L8` inputs have three membership functions, defined with similar points and slopes but processed independently.
- **Rule Configuration**:
  - A total of **6 rules** are used, with three rules dedicated to each lane (low, medium, high for `L2L3` and low, medium, high for `L7L8`).
  - **Output Notation**: Defines lower singleton values (20, 40, 60) for the green light output.
- **Output Singleton Values**: The singleton values used are `20`, `40`, and `60`, which indicate a broader range of green light durations tailored to multi-lane coordination.

### L4_L5 Sequence Controller
- **Asymmetric Membership Functions**:
  - `L4` has only **2 membership functions** (0|1, >1), with points `(0, 20)` and `(20, 100)`, and lower slope values compared to other controllers.
  - `L5` retains the standard 3 membership functions (low, medium, high).
- **Rule Configuration**:
  - This controller uses **8 rules** due to the combination of 2 levels for `L4` and 3 levels for `L5`.
  - The rules include combinations like `L4 0|1` with `L5 low`, `L5 med`, and `L5 high`, as well as `L4 >1` with corresponding levels for `L5`.
- **Output Singleton Values**: Uses singleton values `15`, `30`, and `45`, indicating shorter maximum green light times, optimized for specific traffic patterns within this lane setup.

### L6 Sequence Controller
- **Single Lane Input**: Manages only the `L6` input, represented by an 8-bit vector, making it a simpler configuration similar to `L1`.
- **Standard Membership Functions**:
  - `L6` has **3 membership functions** (low, medium, high) with typical points and slopes.
- **Rule Configuration**:
  - This controller has **3 rules**, corresponding directly to the low, medium, and high levels of `L6`.
- **Output Singleton Values**: Uses singleton values `15`, `22`, and `30`, which are consistent with moderate green light durations tailored for this single lane.

### L9 Sequence Controller
- **Single Lane Input**: Similar to `L6`, this controller handles a single lane, `L9`, with standard fuzzy logic processing.
- **Standard Membership Functions**:
  - `L9` uses **3 membership functions** (low, medium, high) with the same point and slope values as `L6`.
- **Rule Configuration**:
  - Contains **3 rules** for low, medium, and high levels of `L9`, making it a straightforward configuration.
- **Output Singleton Values**: Matches `L6` with singleton values of `15`, `22`, and `30`, suitable for adaptive green light timing based on single-lane traffic density.

---

These differences in configuration allow each controller to target specific lane or lane combinations, with distinct rules, membership functions, and singleton values to meet each lane’s unique traffic requirements.

## State Machine

The **Sequence_State_Machine** is the core control system that coordinates the traffic light sequences, adapting to real-time traffic density inputs and green light durations produced by the fuzzy logic controllers. It functions as a finite state machine (FSM), transitioning between different traffic light sequences, managing green light durations, and ensuring safe transitions with yellow and clearance phases.

### Key Components and Signals

1. **States**  
   The FSM is organized into multiple states, each representing a unique traffic sequence with its own green light duration:
   - **idle**: Initial state where all lights are off.
   - **L1_state, L6_state, L2L3_L7L8_state, L4_L5_state, L9_state**: Main states representing green light sequences for different lane groups. Each of these states is assigned a green light duration determined by the fuzzy logic controllers.
   - **yellow_state**: An intermediary state for yellow lights, signaling the end of a green light phase.
   - **clearance_state**: An all-red state that acts as a buffer between sequence changes, ensuring safe transitions.

2. **Green Light Durations**  
   Each main sequence state (L1, L6, etc.) is controlled by its corresponding fuzzy logic controller, which provides a specific green light duration (`current_green_light`). This duration, based on real-time traffic data, determines how long the light stays green before moving to the next state. Each sequence controller outputs a green light duration signal (e.g., `L1_gl`, `L6_gl`), used by the FSM.

3. **Counters**  
   Three counters are employed to track durations within each state:
   - **counter**: Tracks the green light duration in each main state (L1_state, L6_state, etc.), incrementing every second.
   - **yellow_counter**: Tracks the yellow light duration during the `yellow_state`.
   - **clearance_counter**: Tracks the duration of the all-red state (`clearance_state`), allowing a brief period for safe transitions.

4. **Clock Divider**  
   The FSM operates on a 1 Hz tick, created by dividing the main 25 MHz clock signal. This tick regulates state transitions and counter increments.

5. **Crosswalk Timer Bytes**  
   The state machine manages crosswalk signals using a 4-byte array (`crosswalk_timer_bytes`), representing the pedestrian crossing times at different intersections. These values are transmitted over UART (`tx` output) to synchronize crosswalk signals with the traffic light sequences.

### Process Descriptions

1. **Clock Divider Process**  
   Divides the 25 MHz clock into a 1 Hz `tick` signal, which pulses high once per second to drive state changes and counter increments.

2. **Crosswalk Timer Detection Process**  
   Detects changes in `crosswalk_timer_bytes`, triggering a one-cycle pulse on `reset_internal` to reset the crosswalk timer module whenever new crosswalk data is loaded.

3. **State Register and Counter Process**  
   - **State Update**: Updates the FSM’s current state (`state_reg`) every second according to `state_next`.
   - **Prev_State Tracking**: Keeps track of the previous state during yellow and clearance phases.
   - **Green Light Counter**: Increments while in main sequence states until reaching the green light duration, then transitions to `yellow_state`.
   - **Yellow and Clearance Counters**: Manage the durations of yellow and clearance states, ensuring smooth state transitions.

4. **Combinational State Change Process**  
   Determines the next state (`state_next`) based on the current state and counter values:
   - **Main Sequence States**: Move to `yellow_state` when the green light counter reaches the sequence’s duration.
   - **Yellow State**: Transitions to `clearance_state` after the yellow duration.
   - **Clearance State**: Transitions to the next main sequence based on the sequence order (e.g., from `L1_state` to `L9_state`), creating a continuous cycle through the traffic sequences.

5. **Traffic Light Output Process**  
   Controls traffic light outputs based on the current state:
   - **Green Light States**: Sets specific traffic lights to green according to the active state.
   - **Yellow State**: Sets previously green lights to yellow while others stay red.
   - **Clearance State**: Sets all lights to red, allowing a safe buffer period between sequences.

6. **Crosswalk Timer Output Process**  
   Updates `crosswalk_timer_bytes` based on the current state, sending these values to the crosswalk timer module via UART to align pedestrian signals with the vehicle light cycles.

### Sequence Controller Instantiations

The state machine instantiates each sequence controller (e.g., `L1_Sequence_Controller`, `L6_Sequence_Controller`) for green light timing, using each controller’s output to determine the green light duration for each lane group.

---

Through this coordinated FSM structure, the **Sequence_State_Machine** efficiently manages traffic light sequences across multiple lanes and intersections. By integrating fuzzy logic with precise timing and transitions, the system adapts in real-time to varying traffic conditions, ensuring safe and efficient traffic flow and pedestrian crossings.


## Input Scalar Module

The **Input_Scalar** module manages real-time sensor data, converting raw sensor inputs into scaled values that fit the fuzzy logic system’s universe of discourse (0-100). Each lane’s sensors detect traffic density and translate it into a traffic density percentage for fuzzy logic processing.

### Purpose
The **Input_Scalar** module ensures that each lane’s sensor input is properly scaled according to the lane's specific sensor configuration. By translating the sensor counts into an 8-bit output on a 0-100 scale, the module aligns with the fuzzy logic system’s universe of discourse, enabling seamless integration with the sequence controllers.

### Scaling Logic
- **Three-Sensor Lanes (e.g., L1, L6, L7L8)**: Each lane has up to three sensors. Depending on the number of active sensors (indicating the number of cars), the module outputs values of `33`, `66`, or `99` to reflect traffic density as a percentage. For instance, if one sensor is active, the output is `33`, representing approximately 33% traffic density.
- **Two-Sensor Lanes (e.g., L4, L5)**: Each lane with two sensors outputs either `50` or `100` to represent half or full traffic capacity. This simplifies fuzzy logic calculations and maintains consistency across the modules.

---

## Debounce Filter Module

The **Debounce_Filter** module stabilizes sensor signals, preventing transient noise from affecting system behavior. Since vehicle sensors may intermittently change state as cars move over them, this module ensures accurate, consistent input to the traffic control system.

### Purpose and Benefits
Originally, sensor noise led to frequent, unintended changes in light duration and crosswalk timers. As cars moved across sensors, rapid changes in input data caused fluctuating green light durations and multiple crosswalk activations. With the **Debounce_Filter**, sensor readings remain stable, ensuring that each lane holds its initial traffic density value throughout the green light duration. The crosswalk timer no longer resets mid-sequence due to sensor fluctuations, creating smoother transitions.

### Implementation Details
Each sensor input is passed through a filter with a specific debounce limit, ensuring stability by counting clock cycles. If the sensor input remains stable for the defined debounce limit, the output state updates, effectively filtering out minor input changes due to noise.

---

## Top Module

The **Final_Top** module is the highest-level module in the system, responsible for integrating all other components and linking the system to physical hardware through peripheral ports. It connects the traffic light system to the external constraints file, bridging the internal VHDL logic with physical outputs.

### Key Features and Structure
- **Peripheral-Based Entity Design**: The entity ports are configured to connect to real-world components like sensors, lights, and crosswalk buttons via PMODs, GPIOs, and other FPGA interfaces. This approach enables straightforward integration with the constraints file and physical hardware.
- **Component Connections**: Through port mapping, the **Final_Top** module interconnects the **Debounce Filter**, **Input_Scalar**, and **Sequence_State_Machine** modules, establishing signal flow between them.
- **Role in the System**: Serving as the central hub, **Final_Top** collects sensor data, processes it through the fuzzy logic-based state machine, and controls the physical traffic lights and crosswalk signals in real time, making it the project’s highest hierarchical element and the primary interface to the physical world.

--- 

## Additional Files

### io_map.xdc
The `io_map.xdc` file is a constraints file tailored for the Kria KR260 board and Vivado. This file maps specific I/O ports for this project’s hardware setup, defining connections between the FPGA pins and external peripherals such as traffic lights, sensors, and crosswalk buttons. While this constraints file is exclusive to the Kria KR260 and Vivado, it can be used as a reference for similar configurations on other hardware setups.

